pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = 'your-docker-registry-url'
        DOCKER_CREDENTIALS = 'docker-credentials-id'
        KUBECONFIG_CREDENTIALS = 'kubeconfig-credentials-id'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build') {
            steps {
                script {
                    bat 'docker build -t %DOCKER_REGISTRY%/frontend:latest -f Dockerfile-frontend .' 
                    bat 'docker build -t %DOCKER_REGISTRY%/backend:latest -f Dockerfile-backend .'
                }
            }
        }

        stage('Test') {
            steps {
                script {
                    bat 'docker run --rm %DOCKER_REGISTRY%/backend:latest pytest tests/' 
                }
            }
        }

        stage('Push Images') {
            steps {
                withDockerRegistry([credentialsId: DOCKER_CREDENTIALS, url: "https://%DOCKER_REGISTRY%"]) {
                    bat 'docker push %DOCKER_REGISTRY%/frontend:latest'
                    bat 'docker push %DOCKER_REGISTRY%/backend:latest'
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    powershell 'kubectl apply -f k8s/deployment.yaml'
                }
            }
        }
    }
}
